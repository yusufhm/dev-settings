# symlink to ~/.pygmy.yml

# domain: colima.localhost

resolvers:
- name: MacOS Resolver
  enabled: false
- name: MacOS Colima Resolver
  enabled: true
  folder: /etc/resolver
  file: docker.amazee.io
  data: "# Generated by amazeeio pygmy\nnameserver 192.168.107.2\ndomain docker.amazee.io\nport 6053\n"
  # file: colima.localhost
  # data: "# Generated by amazeeio pygmy\nnameserver 192.168.107.2\ndomain colima.localhost\nport 6053\n"

services:
  amazeeio-ssh-agent:
    Config:
      Labels:
        - pygmy.enable: false
  amazeeio-haproxy:
    Config:
      Labels:
        - pygmy.enable: false
    # HostConfig:
    #   PortBindings:
    #     80/tcp:
    #       - HostPort: 8080
    #     443/tcp:
    #       - HostPort: 8443
  amazeeio-mailhog:
    Config:
      Labels:
        - pygmy.enable: false

  amazeeio-dnsmasq:
    Config:
      Cmd:
        - --log-facility=-
        - --no-resolv
        - -A
        - /docker.amazee.io/192.168.107.2
        # - /colima.localhost/192.168.107.2

  traefik:
    Config:
      Image: traefik:v3.0
      Cmd:
        # - "--log.level=DEBUG"
        - --api
        - --api.insecure=true
        - --providers.docker
        - --providers.docker.exposedbydefault=false
        - --providers.docker.defaultrule=Host(`{{ index .Labels "com.docker.compose.project" }}.docker.amazee.io`)
        - --entrypoints.web.address=:80
        - --entrypoints.websecure.address=:443
      ExposedPorts:
        80/tcp:
          HostPort: 80
        443/tcp:
          HostPort: 443
        8080/tcp:
          HostPort: 8180
      Labels:
        - pygmy.enable: true
        - pygmy.name: traefik
        - pygmy.network: amazeeio-network
        - pygmy.url: http://traefik.docker.amazee.io
        - traefik.docker.network: amazeeio-network
        - traefik.enable: true
        - traefik.port: 80
        - traefik.http.routers.traefik.rule: Host(`traefik.docker.amazee.io`)
        - traefik.http.routers.traefik.tls: true
        - traefik.http.routers.traefik.service: api@internal
        - traefik.providers.docker.defaultport: 8080
    HostConfig:
      Binds:
        - /var/run/docker.sock:/var/run/docker.sock
      PortBindings:
        443/tcp:
          - HostPort: 443
        80/tcp:
          - HostPort: 80
        8080/tcp:
          - HostPort: 8180
      RestartPolicy:
        Name: unless-stopped
        MaximumRetryCount: 0
    NetworkConfig:
      Ports:
        80/tcp:
          - HostPort: 80
        8080/tcp:
          - HostPort: 8180

  mailpit:
    Config:
      Image: axllent/mailpit
      ExposedPorts:
        8025/tcp:
          HostPort: 8025
        1025/tcp:
          HostPort: 1025
      Labels:
        - pygmy.enable: true
        - pygmy.name: mailpit
        - pygmy.network: amazeeio-network
        - pygmy.url: http://mailpit.docker.amazee.io
        - traefik.docker.network: amazeeio-network
        - traefik.enable: true
        - traefik.http.routers.mailpit.rule: Host(`mailpit.docker.amazee.io`)
        - traefik.http.services.mailpit.loadbalancer.server.port: 8025
    HostConfig:
      RestartPolicy:
        Name: unless-stopped
        MaximumRetryCount: 0

  logs:
    Config:
      Image: ghcr.io/yusufhm/udp-listener
      Hostname: application-logs.lagoon.svc
      Labels:
        - pygmy.enable: true
        - pygmy.name: logs
        - pygmy.network: amazeeio-network
    HostConfig:
      RestartPolicy:
        Name: unless-stopped
        MaximumRetryCount: 0

  # fluentbit:
  #   Config:
  #     Image: cr.fluentbit.io/fluent/fluent-bit
  #     Cmd: ["-i", "udp", "-pport=5140", "-o", "stdout"]
  #     Hostname: application-logs.lagoon.svc
  #     Labels:
  #       - pygmy.enable: true
  #       - pygmy.name: fluentbit
  #       - pygmy.network: amazeeio-network
